{% extends 'core/base.html' %}
{% load hash %}
{% load max %}

{% block header %} Ajouter un sondage {% endblock %}
{% block main %}

	<form method="POST" action="{% url 'poll:admin_add_poll' %}">
		{% csrf_token %}
		{{ form.non_field_errors }}

		<div>
			{{ form.title.errors }}
			<label for="{{ form.title.id_for_label }}">Titre: </label>
			{{ form.title }}
		</div>

		<div>
			{{ form.start_time.errors }}
			<label for="{{ form.start_time.id_for_label }}">Début: </label>
			{{ form.start_time }}
		</div>

		<div>
			{{ form.end_time.errors }}
			<label for="{{ form.end_time.id_for_label }}">Fin: </label>
			{{ form.end_time }}
		</div>

		<div id="main_form">
			{% for question, answers in form.questions_answers.items %}
				{{ form.fields | hash_render:question | safe }}
			{% endfor %}
		</div>

		<a href="#" onclick="add_question();">Ajouter une question</a>
		<button>Ajouter</button>
	</form>

	<script>

		var answers_nb = {{ form.q_a_nb | safe }};
		var nb_questions = Math.max.apply(null, Object.keys( answers_nb ).map(function ( key ) { return parseInt(key); }));
		if(nb_questions == '-Infinity'){ nb_questions = 0; }
		function add_question(){
			nb_questions += 1;
			var main_form = document.getElementById("main_form");
			main_form.insertAdjacentHTML('beforeend', "<div id=\"div_q" + nb_questions + "\"><label for=\"q" + nb_questions + "\">Question: </label>" +
													  "<input type=\"text\" id=\"q" + nb_questions + "\" name=\"q" + nb_questions + "\"/>" +
													  "<button onclick=\"add_response(" + nb_questions + "); return false;\">+</button><button onclick=\"del_question(" + nb_questions + ");return false;\">x</button><div id=\"q_a" + nb_questions + "\"></div></div>");

			answers_nb[nb_questions] = 0;
		}

		function add_response(qid){
			answers_nb[qid] += 1;
			var answer_div = document.getElementById("q_a" + qid);
			aid = answers_nb[qid];
			answer_div.insertAdjacentHTML('beforeend', "<div><label for=\"a" + aid + "\">Réponse " + aid + "</label>");
			answer_div.insertAdjacentHTML('beforeend', "<input type=\"text\" name=\"a" + aid + "_q" + qid + "\" id=\"a" + aid +"\"/></div>");
		}

		function del_question(qid){
			var q = document.getElementById("div_q" + qid);
			q.parentNode.removeChild(q);
		}

	</script>

{% endblock %}

